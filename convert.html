<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تحويل الصورة إلى PDF</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
font-family: Tahoma;
background:#f5f5f5;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
}
.box {
background:white;
padding:30px;
border-radius:10px;
box-shadow:0 5px 15px rgba(0,0,0,.1);
text-align:center;
}
</style>
</head>

<body>

<div class="box">
<h2>جاري تحويل الفاتورة إلى PDF...</h2>
<p>سيتم التحميل تلقائيًا</p>
</div>

<script>
const { jsPDF } = window.jspdf;

const params = new URLSearchParams(window.location.search);
const imgUrl = params.get("img");

if (!imgUrl) {
  alert("رابط الصورة غير موجود");
  throw new Error("No image URL");
}

// دالة لفحص إذا تم تحميل الصورة بنجاح
function loadImage(url, retries = 10, delay = 1000) {
  return new Promise((resolve, reject) => {
    const attemptLoad = (count) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.src = url;

      img.onload = () => resolve(img);
      img.onerror = () => {
        if (count > 0) {
          setTimeout(() => attemptLoad(count - 1), delay); // إعادة المحاولة بعد وقت محدد
        } else {
          reject(new Error("فشل تحميل الصورة بعد عدة محاولات"));
        }
      };
    };

    attemptLoad(retries);
  });
}

(async () => {
  try {
    const img = await loadImage(imgUrl, 15, 1000); // 15 محاولة بفاصل ثانية واحدة

    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = pageWidth;
    const imgHeight = (img.height * pageWidth) / img.width;

    let heightLeft = imgHeight;
    let position = 0;

    while (heightLeft > 0) {
      if (position > 0) pdf.addPage();

      const renderHeight = heightLeft > pageHeight ? pageHeight : heightLeft;
      pdf.addImage(img, "PNG", 0, -position, imgWidth, imgHeight);

      heightLeft -= pageHeight;
      position += pageHeight;
    }

    pdf.save("فاتورة.pdf");
  } catch (error) {
    alert(error.message);
  }
})();
</script>



</body>
</html>
